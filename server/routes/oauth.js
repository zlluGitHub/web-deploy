const express=require("express"),router=express.Router(),request=require("request"),config=require("../../config.json");let timeout=18e5;router.post("/github",(code,res,next)=>{let githubConfig={client_ID:config.oauth.github.client_ID,client_Secret:config.oauth.github.client_Secret,access_token_url:config.oauth.github.access_token_url,user_info_url:config.oauth.github.user_info_url+"?",redirect_uri:code.headers.origin+"/login"},host="http://"+code.headers.host;code=code.body.code||"";""!=code?request({url:githubConfig.access_token_url,timeout:timeout,form:{client_id:githubConfig.client_ID,client_secret:githubConfig.client_Secret,code:code,redirect_uri:githubConfig.redirect_uri}},(error,response,urlStr)=>{error||200!=response.statusCode?(console.log(error),res.json({message:"获取用户信息失败！",code:101,result:!1})):(urlStr=githubConfig.user_info_url+urlStr,request({url:urlStr,timeout:timeout,headers:{"User-Agent":config.oauth.github.name}},(error,response,data)=>{error?(console.log(error),res.json({message:"获取用户信息失败！",code:102,result:!1})):(data=JSON.parse(data),request({method:"POST",timeout:timeout,url:`${host}/swd/person/user`,form:{name:data.login,petname:data.name,password:data.email||data.id,speech:data.bio,url:data.avatar_url,web:data.blog,bid:data.node_id,mark:"oauth",type:"y",admin:"1"}},(error,response,data)=>{error||200!=response.statusCode?(console.log(error),res.json({result:!1,code:500})):(data=JSON.parse(data),res.json({code:200,result:!0,data:data}))}))}))}):res.json({message:"请输入正确参数！",code:103,result:!1})}),router.post("/gitee",(code,res,next)=>{let githubConfig={client_ID:config.oauth.gitee.client_ID,client_Secret:config.oauth.gitee.client_Secret,access_token_url:config.oauth.gitee.access_token_url,user_info_url:config.oauth.gitee.user_info_url,redirect_uri:code.headers.origin+"/login"},host="http://"+code.headers.host;code=code.body.code||"";""!=code?request({url:githubConfig.access_token_url,timeout:timeout,method:"POST",form:{grant_type:"authorization_code",code:code,client_id:githubConfig.client_ID,client_secret:githubConfig.client_Secret,redirect_uri:githubConfig.redirect_uri}},(error,response,body)=>{error||200!=response.statusCode?(console.log(error),res.json({message:"获取用户信息失败！",code:101,result:!1})):(body=JSON.parse(body),request({url:githubConfig.access_token_url,timeout:timeout,method:"POST",form:{grant_type:"refresh_token",refresh_token:body.refresh_token},headers:config.oauth.gitee.headers},(error,response,data)=>{error?(console.log(error),res.json({message:"获取用户信息失败！",code:102,result:!1})):(data=JSON.parse(data),request({url:githubConfig.user_info_url,timeout:timeout,form:{access_token:data.access_token}},(error,response,data)=>{error?(console.log(error),res.json({message:"获取用户信息失败！",code:104,result:!1})):(data=JSON.parse(data),request({method:"POST",timeout:timeout,url:`${host}/swd/person/user`,form:{name:data.login,petname:data.name,password:data.email||data.id,url:data.avatar_url,web:data.blog,speech:data.bio,git:data.html_url,email:data.email,mark:"oauth",type:"y",admin:"1"}},(error,response,data)=>{error||200!=response.statusCode?(console.log(error),res.json({result:!1,code:500})):(data=JSON.parse(data),res.json({code:200,result:!0,data:data}))}))}))}))}):res.json({message:"请输入正确参数！",code:103,result:!1})}),router.post("/gitlab",(code,res,next)=>{let githubConfig={client_ID:config.oauth.gitlab.client_ID,client_Secret:config.oauth.gitlab.client_Secret,access_token_url:config.oauth.gitlab.access_token_url,user_info_url:config.oauth.gitlab.user_info_url,redirect_uri:code.headers.origin+"/login"},host="http://"+code.headers.host;code=code.body.code||"";""!=code?request({url:githubConfig.access_token_url,timeout:timeout,method:"POST",form:{grant_type:"authorization_code",code:code,client_id:githubConfig.client_ID,client_secret:githubConfig.client_Secret,redirect_uri:githubConfig.redirect_uri}},(error,response,body)=>{error||200!=response.statusCode?(console.log(error),res.json({message:"获取用户信息失败！",code:101,result:!1})):(body=JSON.parse(body),request({url:githubConfig.user_info_url,timeout:timeout,form:{access_token:body.access_token}},(error,response,data)=>{error?(console.log(error),res.json({message:"获取用户信息失败！",code:104,result:!1})):(data=JSON.parse(data),request({method:"POST",timeout:timeout,url:`${host}/swd/person/user`,form:{name:data.name,petname:data.username,password:data.email||data.id,url:data.avatar_url,web:data.web_url,git:data.web_url,email:data.email,mark:"oauth",type:"y",admin:"1"}},(error,response,data)=>{error||200!=response.statusCode?(console.log(error),res.json({result:!1,code:500})):(data=JSON.parse(data),res.json({code:200,result:!0,data:data}))}))}))}):res.json({message:"请输入正确参数！",code:103,result:!1})}),module.exports=router;