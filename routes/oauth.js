const express=require("express"),router=express.Router(),config=require("../deploy.config.js"),stopProcess=require("../javascript/index")["stopProcess"],axios=require("axios");router.post("/github",async(user_agent,res,next)=>{var code=user_agent.body["code"],{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri,user_agent}=config.oauth.github;code||(res.json({message:"参数 code 不得为空！",code:100}),stopProcess());let token="";await axios.get(access_token_url,{params:{client_id:client_ID,client_secret:client_Secret,code:code,redirect_uri:redirect_uri}}).then(response=>{token=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101}),stopProcess()});let data={};await axios.get(user_info_url+("?"+token),{headers:{"User-Agent":user_agent}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102}),stopProcess()}),await axios.post(global.store.origin+"/wd/user/register",{name:data.name,password:data.id,url:data.avatar_url,email:data.email,oauth:"github",role:"general"}).then(res=>{res.json({code:200,data:res.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104})})}),router.post("/gitee",async(user_agent,res,next)=>{var code=user_agent.body["code"],{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri,user_agent}=config.oauth.gitee;code||(res.json({message:"参数 code 不得为空！",code:100}),stopProcess());let refresh_token="";await axios.post(access_token_url,{grant_type:"authorization_code",code:code,client_id:client_ID,client_secret:client_Secret,redirect_uri:redirect_uri}).then(response=>{refresh_token=response.data.refresh_token}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101}),stopProcess()});let token="";await axios.post(access_token_url,{grant_type:"refresh_token",refresh_token:refresh_token},{headers:{"User-Agent":user_agent}}).then(response=>{token=response.data.access_token}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102}),stopProcess()});let data={};await axios.get(user_info_url,{params:{access_token:token}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102}),stopProcess()}),await axios.post(global.store.origin+"/wd/user/register",{name:data.name,password:data.id,url:data.avatar_url,email:data.email,oauth:"gitee",role:"general"}).then(response=>{res.json({code:200,data:response.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104})})}),router.post("/gitlab",async(redirect_uri,res,next)=>{var code=redirect_uri.body["code"],{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri}=config.oauth.gitlab;code||(res.json({message:"参数 code 不得为空！",code:100}),stopProcess());let token="";await axios.post(access_token_url,{grant_type:"authorization_code",code:code,client_id:client_ID,client_secret:client_Secret,redirect_uri:redirect_uri}).then(response=>{token=response.data.access_token}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101}),stopProcess()});let data={};await axios.get(user_info_url,{params:{access_token:token}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102}),stopProcess()}),await axios.post(global.store.origin+"/wd/user/register",{name:data.name,password:data.id,url:data.avatar_url,email:data.email,oauth:"gitlab",role:"general"}).then(response=>{res.json({code:200,data:response.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104})})}),router.post("/gitea",async(redirect_uri,res,next)=>{var code=redirect_uri.body["code"],{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri}=config.oauth.gitea;code||(res.json({message:"参数 code 不得为空！",code:100}),stopProcess());let token="";await axios.post(access_token_url,{grant_type:"authorization_code",code:code,client_id:client_ID,client_secret:client_Secret,redirect_uri:redirect_uri}).then(response=>{token=response.data.access_token}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101}),stopProcess()});let data={};await axios.get(user_info_url,{params:{access_token:token}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102}),stopProcess()}),await axios.post(global.store.origin+"/wd/user/register",{name:data.name||data.username,password:data.id,url:data.avatar_url,email:data.email,oauth:"gitea",role:"general"}).then(response=>{res.json({code:200,data:response.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104})})}),router.get("/config",(req,res,next)=>{res.json({code:200,data:{...config.oauth,ws:config.ws}})}),module.exports=router;