const express=require("express"),router=express.Router(),userSchema=require("../schema/user"),email=require("../javascript/email"),datetime=require("silly-datetime"),uuidv4=require("uuid")["v4"],axios=require("axios");router.get("/get",async(p2,res,next)=>{let{pageSize,pageNo,bid,name,email}=p2.query;pageSize=pageSize?+pageSize:10,pageNo=pageNo?+pageNo-1:0;let filter={};bid?filter.bid=bid:(name&&(filter.name={$regex:new RegExp(""+name,"gi")}),email&&(filter.email={$regex:new RegExp(""+email,"gi")}));var p1=new Promise((resolve,reject)=>{userSchema.find(filter,{_id:0,__v:0},(err,data)=>{err?reject(err):resolve(data)}).skip(pageNo*pageSize).limit(pageSize).sort({_id:-1})}),p2=new Promise((resolve,reject)=>{userSchema.find(filter).count((err,count)=>{err?reject(err):resolve(count)})});Promise.all([p1,p2]).then(result=>{res.json({message:"请求成功！",code:200,data:(bid?result[0]:result)[0],total:result[1]})}).catch(error=>{console.log(error),res.json({message:"系统错误！",code:500})})}),router.post("/login",(body,res,next)=>{body=body.body;userSchema.find({email:body.email,password:body.password+""},(err,data)=>{err?(res.json({message:"登陆失败，请重新登录！",code:500}),console.log(err)):data[0]?res.json({data:{email:data[0].email,bid:data[0].bid,role:data[0].role,url:data[0].url,name:data[0].name},message:"登陆成功！",code:200}):res.json({code:500,message:"登录失败，请检查账号密码是否正确！"})})}),router.post("/register",async(req,res,next)=>{let body=req.body;const createUserInfo=body=>{body.bid=uuidv4(),body.createTime=datetime.format(new Date,"YYYY-MM-DD HH:mm:ss"),body.updateTime=body.createTime,userSchema.create(body,(err,data)=>{err?(console.log(err),res.json({code:500,message:"注册失败，请重试！"})):"gitee"==body.oauth||"gitlab"==body.oauth||"gitea"==body.oauth||"github"==body.oauth?res.json({code:200,data:body}):res.json({type:"success",message:"恭喜，注册成功，请登录！",code:200})})};userSchema.find({email:body.email},(err,data)=>{err?(res.json({code:500,message:"注册失败，请重试！"}),console.log(err)):data[0]?"gitee"==body.oauth||"gitlab"==body.oauth||"gitea"==body.oauth||"github"==body.oauth?res.json({code:200,data:data[0]}):res.json({code:200,type:"warning",message:"该邮箱已被注册，请更换其它邮箱注册！"}):"gitee"==body.oauth||"gitlab"==body.oauth||"gitea"==body.oauth||"github"==body.oauth?createUserInfo(body):axios.post(global.store.origin+"/wd/user/email",body).then(()=>{createUserInfo(body)}).catch(()=>{res.json({code:500,message:"注册失败，请检查邮箱是否正确！"})})})}),router.post("/delete",(bid,res,next)=>{bid=bid.body.bid;userSchema.deleteOne({bid:bid},(err,data)=>err?(console.log("错误信息：",err),void res.json({result:!1,code:500})):void res.json({result:!0,code:200,data:data}))}),router.post("/update",(body,res,next)=>{body=body.body;userSchema.updateOne({bid:body.bid},{$set:body},(err,data)=>{err?(res.json({code:500,message:"信息更新失败！"}),console.log("错误信息：",err)):res.json({code:200,message:"信息更新成功！"})})}),router.post("/email",(body,res,next)=>{body=body.body;email.send({title:"【前端自动化部署平台-系统通知】",to:body.email,msg:`<${body.email}> 您好，欢迎使用 “前端自动化部署平台”，您已注册成功！`}).then(()=>{res.json({code:200,message:"邮件发送成功！"})}).catch(()=>{res.json({code:500,message:"邮件发送失败！"})})}),module.exports=router;