const express=require("express"),router=express.Router(),axios=require("axios");router.post("/webhook",(req,res,next)=>{res.json({code:200});let resBody=req.body,key="";req.get("X-Gitee-Token")?key=req.get("X-Gitee-Token"):req.get("X-Gitlab-Token")?key=req.get("X-Gitlab-Token"):req.query.key?key=req.query.key:resBody.secret&&(key=resBody.secret),axios.get(global.store.origin+"/wd/deploy/get",{params:{bid:key}}).then(res=>{if(200==res.data.code){let body=res.data.data;body&&body.state.isAuto&&body.state.isServer&&("1"==body.type||"3"==body.type)&&(body.file={added:resBody.commits[0].added,removed:resBody.commits[0].removed,modified:resBody.commits[0].modified,before:resBody.before,after:resBody.after,url:resBody.commits[0].url},body.activeType=body.type="b",body.remark=resBody.commits[0].message||"",axios.post(global.store.origin+"/wd/deploy/update",body).then(res=>{console.log(res.data)}).catch(error=>{console.log(error)}))}}).catch(error=>{console.log(error)})}),module.exports=router;