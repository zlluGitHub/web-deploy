const express=require("express"),router=express.Router(),config=require("../../config.json"),axios=require("axios");let timeout=18e5;router.post("/github",async(req,res,next)=>{var{code}=req.body,{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri,user_agent}=config.oauth.github;code||(res.json({message:"参数 code 不得为空！",code:100,result:!1}),process.exit(1));let token="";await axios.get(access_token_url,{params:{client_id:client_ID,client_secret:client_Secret,code:code,redirect_uri:redirect_uri}}).then(response=>{token=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101,result:!1}),process.exit(1)}),console.log(token);let data={};await axios.get(user_info_url+`?${token}`,{headers:{"User-Agent":user_agent}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102,result:!1}),process.exit(1)}),await axios.post(`${req.headers.origin}/swd/person/user/register`,{name:data.name,petname:data.login,password:data.id,url:data.avatar_url,bid:data.node_id,email:data.email,mark:"github",web:data.blog,speech:data.bio,type:"y",admin:"1"}).then(res=>{res.json({code:200,result:!0,data:res.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104,result:!1})})}),router.post("/gitee",async(req,res,next)=>{var{code}=req.body,{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri,user_agent}=config.oauth.gitee;code||(res.json({message:"参数 code 不得为空！",code:100,result:!1}),process.exit(1));let refresh_token="";await axios.post(access_token_url,{grant_type:"authorization_code",code:code,client_id:client_ID,client_secret:client_Secret,redirect_uri:redirect_uri}).then(response=>{refresh_token=response.data.refresh_token}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101,result:!1}),process.exit(1)});let token="";await axios.post(access_token_url,{grant_type:"refresh_token",refresh_token:refresh_token},{headers:{"User-Agent":user_agent}}).then(response=>{token=response.data.access_token}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102,result:!1}),process.exit(1)});let data={};await axios.get(user_info_url,{params:{access_token:token}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102,result:!1}),process.exit(1)}),await axios.post(`${req.headers.origin}/swd/person/user/register`,{name:data.name,petname:data.login,password:data.id,url:data.avatar_url,bid:data.node_id,email:data.email,web:data.blog,speech:data.bio,git:data.html_url,mark:"gitee",type:"y",admin:"1"}).then(response=>{res.json({code:200,result:!0,data:response.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104,result:!1})})}),router.post("/gitlab",async(req,res,next)=>{var{code}=req.body,{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri}=config.oauth.gitlab;code||(res.json({message:"参数 code 不得为空！",code:100,result:!1}),process.exit(1));let token="";await axios.post(access_token_url,{grant_type:"authorization_code",code:code,client_id:client_ID,client_secret:client_Secret,redirect_uri:redirect_uri}).then(response=>{token=response.data.access_token}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101,result:!1}),process.exit(1)});let data={};await axios.get(user_info_url,{params:{access_token:token}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102,result:!1}),process.exit(1)}),await axios.post(`${req.headers.origin}/swd/person/user/register`,{name:data.name,petname:data.username,password:data.id,url:data.avatar_url,email:data.email,web:data.web_url,git:data.web_url,mark:"gitlab",type:"y",admin:"1"}).then(response=>{res.json({code:200,result:!0,data:response.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104,result:!1})})}),router.post("/gitea",async(req,res,next)=>{var{code}=req.body,{client_ID,client_Secret,access_token_url,user_info_url,redirect_uri}=config.oauth.gitea;code||(res.json({message:"参数 code 不得为空！",code:100,result:!1}),process.exit(1));let token="";await axios.post(access_token_url,{grant_type:"authorization_code",code:code,client_id:client_ID,client_secret:client_Secret,redirect_uri:redirect_uri}).then(response=>{token=response.data.access_token}).catch(error=>{console.log(error),res.json({message:"获取用户 Token 失败！",code:101,result:!1}),process.exit(1)});let data={};await axios.get(user_info_url,{params:{access_token:token}}).then(response=>{data=response.data}).catch(error=>{console.log(error),res.json({message:"获取用户信息失败！",code:102,result:!1}),process.exit(1)}),await axios.post(`${req.headers.origin}/swd/person/user/register`,{name:data.username,petname:data.login,password:data.id,url:data.avatar_url,email:data.email,mark:"gitea",type:"y",admin:"1"}).then(response=>{res.json({code:200,result:!0,data:response.data.data})}).catch(error=>{console.log(error),res.json({message:"用户信息验证信息时发生错误！",code:104,result:!1})})}),router.get("/config",(req,res,next)=>{res.json({code:200,result:!0,data:config.oauth||{}})}),module.exports=router;