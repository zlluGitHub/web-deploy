const express=require("express"),router=express.Router(),user=require("../schema/user"),datetime=require("silly-datetime"),{v4:uuidv4}=require("uuid");router.post("/login",(body,res,next)=>{body=body.body;user.find({name:body.name,password:body.password+""},(err,data)=>{err?(console.log("错误信息：",err),res.json({message:"用户信息校验失败！",code:500})):data[0]?res.json({result:!0,data:{name:data[0].name,bid:data[0].bid,url:data[0].url},message:"用户登陆成功！",code:200}):res.json({result:!1,code:500,message:"登录失败，请检查账号密码是否正确！"})})}),router.post("/register",async(req,res,next)=>{let body=req.body,result=null;await user.find({name:body.name,password:body.password+""},(err,data)=>{err?(res.json({code:500,message:"用户信息查询失败！"}),process.exit(1)):result=data[0]}),result?res.json({result:!0,data:{name:result.name,bid:result.bid,url:result.url},code:201,message:"您已注册，请直接登录！"}):(body.bid=body.bid||uuidv4(),body.createTime=datetime.format(new Date,"YYYY-MM-DD HH:mm:ss"),body.updateTime=body.createTime,body.mark=body.mark||"self",user.create(body,(err,data)=>{err?(console.log("错误信息：",err),res.json({result:!1,message:"抱歉，注册失败！",code:500})):res.json({result:!0,data:{name:body.name,bid:body.bid,url:body.url},message:"恭喜，注册成功，请登录！",code:200})}))}),router.post("/delete",(bid,res,next)=>{bid=bid.query.bid;user.deleteOne({bid:bid},(err,data)=>err?(console.log("错误信息：",err),void res.json({result:!1,code:500})):void res.json({result:!0,code:200,data:data}))}),router.post("/update",(body,res,next)=>{body=body.body;user.updateOne({bid:body.bid},{$set:body},(err,data)=>{err?(res.json({code:500,message:"信息更新失败！"}),console.log("错误信息：",err)):res.json({code:200,message:"信息更新成功！"})})}),module.exports=router;